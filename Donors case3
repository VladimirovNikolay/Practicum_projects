/*Основные задачи
Определить регионы с наибольшим количеством зарегистрированных доноров.
Изучить динамику общего количества донаций в месяц за 2022 и 2023 годы.
Определить наиболее активных доноров в системе, учитывая только данные о зарегистрированных и подтвержденных донациях.
Оценить, как система бонусов влияет на зарегистрированные в системе донации.
Исследовать вовлечение новых доноров через социальные сети. Узнать, сколько по каким каналам пришло доноров, и среднее количество донаций по каждому каналу.
Сравнить активность однократных доноров со средней активностью повторных доноров.
Сравнить данные о планируемых донациях с фактическими данными, чтобы оценить эффективность планирования.*/
/* --1)
 *SELECT
    region,
    COUNT(id) AS count_users
FROM donorsearch.user_anon_data
GROUP BY region
ORDER BY count_users DESC
LIMIT 30 */

--2)Изучить динамику общего количества донаций в месяц за 2022 и 2023 годы.
/*SELECT 
	date_trunc('month', donation_date::timestamp)::date AS month,
	COUNT(id) AS count_donations
FROM donorsearch.donation_anon
WHERE EXTRACT(YEAR FROM donation_date) BETWEEN 2022 AND 2023
GROUP BY MONTH*/

--3) Определить наиболее активных доноров в системе, учитывая только данные о зарегистрированных и подтвержденных донациях.
/*SELECT 
user_id,
COUNT(id) AS count_donation
FROM donorsearch.donation_anon
WHERE donation_status = 'Принята'
GROUP BY user_id
ORDER BY count_donation DESC
LIMIT 10*/
--4)Оценить, как система бонусов влияет на зарегистрированные в системе донации.
/*WITH donor_bonus AS
(
	SELECT 
		u.id,
		u.confirmed_donations,
		COALESCE(b.user_bonus_count, 0) AS user_bonus_count
	FROM user_anon_data AS u
	LEFT JOIN user_anon_bonus AS b ON u.id = b.user_id
)
SELECT 
	CASE
		WHEN user_bonus_count = 0
		THEN 'Без бонусов'
		ELSE 'С бонусами'
	END AS motivation,
	COUNT(id) AS count_users,
	ROUND(AVG(confirmed_donations), 2) AS avg_donations
FROM donor_bonus
GROUP BY motivation*/
--5)Исследовать вовлечение новых доноров через социальные сети. Узнать, сколько по каким каналам пришло доноров, и среднее количество донаций по каждому каналу.
/*SELECT 
	CASE 
		WHEN autho_vk = True
		THEN 'ВКонтакте'
		WHEN autho_ok = True
		THEN 'Одноклассники'
		WHEN autho_tg = True
		THEN 'Телеграм'
		WHEN autho_yandex = True
		THEN 'Яндекс'
		WHEN autho_google = True
		THEN 'Google'
		ELSE 'Другое'
	END AS where_user,
	COUNT(id) AS count_users,
	AVG(confirmed_donations) AS avg_donations
FROM donorsearch.user_anon_data
GROUP BY where_user
ORDER BY count_users DESC*/
--6) Сравнить активность однократных доноров со средней активностью повторных доноров.
/*SELECT 
	CASE 
		WHEN confirmed_donations = 1
		THEN 'Однократный донор'
		WHEN confirmed_donations > 1
		THEN 'Многократный донор'
		ELSE 'Ни разу не сдавал'
	END AS donations,
	COUNT(id) AS count_doners,
	ROUND(AVG(confirmed_donations), 2) AS avg_donations
	FROM donorsearch.user_anon_data
	GROUP BY donations*/
--7)Сравнить данные о планируемых донациях с фактическими данными, чтобы оценить эффективность планирования.
WITH plat_donation AS
(	
	SELECT 
		DISTINCT user_id,
		donation_date,
		donation_type
	FROM donorsearch.donation_plan
),
fact_donation AS 
(
	SELECT 
		DISTINCT user_id,
		donation_date
	FROM donorsearch.donation_anon
),
all_donations AS
(
	SELECT 
		pd.user_id,
		pd.donation_date,
		pd.donation_type,
		CASE 
			WHEN fd.user_id IS NOT NULL
			THEN 1
			ELSE 0
		END AS done
		FROM plat_donation AS pd
		LEFT JOIN fact_donation AS fd ON pd.user_id = fd.user_id AND pd.donation_date =  fd.donation_date	
)
SELECT 
	donation_type,
	COUNT(*) AS plan_donation,
	SUM(done) AS done_donation,
	(COUNT(*) - SUM(done)) AS not_donation,
	ROUND((SUM(done) * 100.0 / COUNT(*)), 2) AS rate
	FROM all_donations
	GROUP BY donation_type
	
	
